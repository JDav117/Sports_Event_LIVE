name: CI & CD - Sports Events Platform

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'test/**'
      - 'package.json'
      - 'tsconfig.json'
      - '.github/workflows/CI.yml'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: "CI-CD-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # Job de verificaciÃ³n bÃ¡sica
  verificar_entorno:
    name: Verificar Entorno y Dependencias
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Mostrar informaciÃ³n del sistema
        run: |
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ–¥ï¸  Sistema Operativo: $(uname -a)"
          echo "ğŸ“‚ Directorio de trabajo: $(pwd)"

      - name: Verificar estructura del proyecto
        run: |
          echo "ğŸ“‹ Verificando archivos principales..."
          if [ -f "package.json" ]; then
            echo "âœ… package.json encontrado"
          else
            echo "âŒ package.json no encontrado"
            exit 1
          fi
          
          if [ -f "nest-cli.json" ]; then
            echo "âœ… nest-cli.json encontrado"
          else
            echo "âŒ nest-cli.json no encontrado"
            exit 1
          fi
          
          if [ -d "src" ]; then
            echo "âœ… Directorio src/ encontrado"
          else
            echo "âŒ Directorio src/ no encontrado"
            exit 1
          fi

      - name: Mostrar archivos del proyecto
        run: ls -la

      - name: Mostrar versiÃ³n de Node.js
        run: node --version

      - name: Mostrar versiÃ³n de npm
        run: npm --version

  # Job principal de CI
  build_and_test:
    name: Build, Lint y Tests
    needs: verificar_entorno
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: sports_events_test
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass123
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Compilar proyecto
        run: npm run build

      - name: Ejecutar anÃ¡lisis de cÃ³digo (Linting)
        run: npm run lint

      - name: Ejecutar pruebas unitarias con cobertura
        run: npm run test:cov

      - name: Ejecutar pruebas E2E
        env:
          DB_HOST: localhost
          DB_PORT: "3306"
          DB_USERNAME: testuser
          DB_PASSWORD: testpass123
          DB_DATABASE: sports_events_test
        run: npm run test:e2e -- --forceExit

      - name: Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Resumen de resultados
        if: success()
        run: |
          echo "âœ… Â¡CI Completado Exitosamente!"
          echo "ğŸ“Š Build: OK"
          echo "ğŸ” Linting: OK"
          echo "ğŸ§ª Tests: OK"

  # Job de anÃ¡lisis de seguridad (opcional)
  security_audit:
    name: AuditorÃ­a de Seguridad
    needs: verificar_entorno
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: AuditorÃ­a de dependencias
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Job de notificaciÃ³n final
  notificar_resultado:
    name: NotificaciÃ³n de Resultado
    needs: [build_and_test, security_audit]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Estado del CI/CD
        run: |
          if [ "${{ needs.build_and_test.result }}" == "success" ]; then
            echo "ğŸ‰ Â¡Pipeline de CI/CD completado con Ã©xito!"
            echo "âœ… Todos los tests pasaron"
            echo "âœ… Build completado"
            echo "âœ… Linting pasado"
          else
            echo "âŒ El pipeline de CI/CD fallÃ³"
            echo "Por favor, revisa los logs anteriores"
            exit 1
          fi
